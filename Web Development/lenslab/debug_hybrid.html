<!DOCTYPE html>
<html>
<head>
    <title>üîß Debug Hybrid Loader</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <h1>üîß Debug Hybrid Loader</h1>
    <div id="logs"></div>
    
    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }
        
        log('Starting debug session...');
        
        // Check if our WebAssembly files exist
        log('Checking WebAssembly files...');
        
        fetch('mtf_analyzer.js')
            .then(response => {
                if (response.ok) {
                    log('‚úÖ mtf_analyzer.js found', 'success');
                    return fetch('mtf_analyzer.wasm');
                } else {
                    throw new Error(`mtf_analyzer.js not found (${response.status})`);
                }
            })
            .then(response => {
                if (response.ok) {
                    log('‚úÖ mtf_analyzer.wasm found', 'success');
                    log('Loading WebAssembly module...');
                    loadWebAssembly();
                } else {
                    throw new Error(`mtf_analyzer.wasm not found (${response.status})`);
                }
            })
            .catch(error => {
                log(`‚ùå ${error.message}`, 'error');
                log('Make sure both mtf_analyzer.js and mtf_analyzer.wasm are in the same directory as this HTML file');
            });
        
        // Test WebAssembly loading
        function loadWebAssembly() {
            const script = document.createElement('script');
            script.src = 'mtf_analyzer.js';
            script.onload = function() {
                log('‚úÖ mtf_analyzer.js script loaded', 'success');
                
                if (typeof MTFAnalyzer === 'undefined') {
                    log('‚ùå MTFAnalyzer function not found', 'error');
                    return;
                }
                
                log('MTFAnalyzer function found, initializing...');
                
                MTFAnalyzer()
                    .then(module => {
                        log('‚úÖ WebAssembly module initialized successfully!', 'success');
                        
                        // Test the module
                        try {
                            const result = module.MTFAnalyzerWasm.testConnection();
                            log(`‚úÖ WebAssembly test: ${result}`, 'success');
                        } catch (error) {
                            log(`‚ùå WebAssembly test failed: ${error.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        log(`‚ùå WebAssembly initialization failed: ${error.message}`, 'error');
                    });
            };
            
            script.onerror = function() {
                log('‚ùå Failed to load mtf_analyzer.js script', 'error');
            };
            
            document.head.appendChild(script);
        }
        
        // Test OpenCV.js loading
        log('Testing OpenCV.js...');
        const opencvScript = document.createElement('script');
        opencvScript.src = 'https://docs.opencv.org/4.x/opencv.js';
        opencvScript.onload = function() {
            log('‚úÖ OpenCV.js script loaded', 'success');
            
            // Wait for cv to be available
            let attempts = 0;
            const checkCV = setInterval(() => {
                attempts++;
                if (typeof cv !== 'undefined' && cv.Mat) {
                    clearInterval(checkCV);
                    log('‚úÖ OpenCV.js fully loaded and ready!', 'success');
                    log(`Available functions: Mat=${typeof cv.Mat}, Canny=${typeof cv.Canny}, HoughLinesP=${typeof cv.HoughLinesP}`);
                } else if (attempts > 50) {
                    clearInterval(checkCV);
                    log('‚ùå OpenCV.js timeout - cv object not available after 5 seconds', 'error');
                    log(`cv type: ${typeof cv}, window.cv type: ${typeof window.cv}`);
                }
            }, 100);
        };
        
        opencvScript.onerror = function() {
            log('‚ùå Failed to load OpenCV.js from CDN', 'error');
        };
        
        document.head.appendChild(opencvScript);
    </script>
</body>
</html>